<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Haptic Game</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        
        /* 1. Camera Background */
        #camera-feed {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            object-fit: cover;
            z-index: 1;
        }

        /* 2. HUD Layer */
        #hud {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 10;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The Player's Fixed Reticle */
        #reticle {
            width: 50px; height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            /* Add a crosshair */
            display: flex; justify-content: center; align-items: center;
        }
        #reticle::after {
            content: '+'; color: white; font-size: 20px; font-weight: bold;
        }

        /* The Moving Target */
        #target {
            width: 100px; height: 100px; /* Made larger */
            background: radial-gradient(circle, #ff4444 0%, #cc0000 100%);
            border: 4px solid white;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%); /* Centers the div on its coordinate */
            display: none; 
            box-shadow: 0 0 30px #ff0000;
            transition: background 0.2s;
        }

        /* Haptic Hack Switch */
        .haptic-hack { position: absolute; opacity: 0; pointer-events: none; }

        /* UI Overlay */
        #overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 20;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        button {
            padding: 16px 32px; font-size: 20px;
            background: #007AFF; color: white;
            border: none; border-radius: 30px;
            margin-top: 30px; cursor: pointer;
            font-weight: bold;
        }
        
        /* Debug Info */
        #debug-info {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            text-align: center; color: rgba(255,255,255,0.7);
            font-size: 14px; z-index: 15;
            pointer-events: none;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>

    <div id="hud">
        <div id="reticle"></div> 
        <div id="target"></div>
    </div>

    <!-- Haptic Trigger -->
    <label class="haptic-hack"><input type="checkbox" switch id="haptic-switch"></label>

    <!-- Debug Text -->
    <div id="debug-info">Waiting to start...</div>

    <!-- Start Screen -->
    <div id="overlay">
        <h1>AR Pursuit</h1>
        <p style="padding: 0 30px; line-height: 1.5;">
            1. Keep the Reticle on the Red Target.<br>
            2. The Target will move.<br>
            3. Phone vibrates if you lose it.
        </p>
        <button id="start-btn">Start Game</button>
    </div>

    <script>
        // --- GAME CONFIG ---
        const SENSITIVITY = 15;        // Pixels per degree of rotation
        const TARGET_SPEED = 0.3;      // How fast the target wanders
        const MAX_VIBRATION_INTERVAL = 400; 
        const MIN_VIBRATION_INTERVAL = 30;  

        // --- STATE ---
        let isRunning = false;
        let calibrated = false;
        
        // Sensor Data (Phone)
        let phoneOrientation = { alpha: 0, beta: 90, gamma: 0 };
        
        // World Data (Target)
        let targetWorldPos = { yaw: 0, pitch: 90 }; 
        
        // Haptics
        let lastHapticTime = 0;
        let currentHapticInterval = 0; 
        const hapticSwitch = document.getElementById('haptic-switch');

        // Elements
        const targetEl = document.getElementById('target');
        const overlay = document.getElementById('overlay');
        const startBtn = document.getElementById('start-btn');
        const video = document.getElementById('camera-feed');
        const debugEl = document.getElementById('debug-info');

        // --- 1. STARTUP ---
        startBtn.addEventListener('click', async () => {
            try {
                // Request Motion Permission FIRST
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') {
                        alert('Motion permission denied. Game cannot play.');
                        return;
                    }
                }

                // Request Camera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;

                // Listeners
                window.addEventListener('deviceorientation', handleOrientation);

                // UI Reset
                overlay.style.display = 'none';
                targetEl.style.display = 'block';
                isRunning = true;
                
                // Start Loop
                requestAnimationFrame(gameLoop);

            } catch (err) {
                alert("Start Error: " + err.message);
            }
        });

        // --- 2. SENSOR HANDLER ---
        function handleOrientation(event) {
            // alpha: 0-360 (Compass)
            // beta: -180 to 180 (Front/Back Tilt). 90 is upright.
            // gamma: -90 to 90 (Left/Right Tilt)
            
            // Normalize values to avoid nulls
            phoneOrientation.alpha = event.alpha || 0;
            phoneOrientation.beta = event.beta || 90;
            phoneOrientation.gamma = event.gamma || 0;

            // Calibration: On first frame, place target exactly where user is looking
            if (!calibrated && isRunning) {
                targetWorldPos.yaw = phoneOrientation.alpha;
                targetWorldPos.pitch = phoneOrientation.beta;
                calibrated = true;
            }
        }

        // --- 3. GAME LOOP ---
        function gameLoop(timestamp) {
            if (!isRunning) return;

            // A. UPDATE TARGET (Wander Logic)
            // We use Sine waves based on time to create smooth wandering
            const time = timestamp / 1000; // Seconds
            
            // Target moves in a figure-8-ish pattern around its origin
            // We update the "World Position" of the target relative to calibration
            if (calibrated) {
                // Add drift to the initial position
                // Yaw (Left/Right) +/- 20 degrees
                targetWorldPos.yaw += Math.sin(time) * TARGET_SPEED;
                
                // Pitch (Up/Down) +/- 10 degrees
                targetWorldPos.pitch += Math.cos(time * 0.8) * TARGET_SPEED;
            }

            // B. CALCULATE SCREEN POSITION
            // Calculate difference between Phone Look Direction and Target Position
            let yawDiff = targetWorldPos.yaw - phoneOrientation.alpha;
            let pitchDiff = targetWorldPos.pitch - phoneOrientation.beta;

            // Handle Compass Wrap (359 -> 1 degree is only 2 degrees difference, not -358)
            if (yawDiff > 180) yawDiff -= 360;
            if (yawDiff < -180) yawDiff += 360;

            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Map Degree Diff to Pixel Offset
            const x = centerX + (yawDiff * SENSITIVITY);
            
            // NOTE: Invert Y. If Target is "Higher" (Pitch > Phone), it should be UP on screen (Negative Y)
            const y = centerY - (pitchDiff * SENSITIVITY); 

            // Apply to DOM
            targetEl.style.transform = `translate(${x}px, ${y}px)`;


            // C. GAMEPLAY & HAPTICS
            // Calculate distance from center of screen
            const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            
            // Debug Info
            debugEl.innerText = `Dist: ${Math.round(dist)}px | Yaw: ${Math.round(phoneOrientation.alpha)} | Pitch: ${Math.round(phoneOrientation.beta)}`;

            // Zone Logic
            const safeZone = 80; // Pixels
            const dangerZone = 500; // Pixels

            if (dist < safeZone) {
                // Safe: Green, No Vibrate
                targetEl.style.background = "#00ff00";
                targetEl.style.borderColor = "white";
                currentHapticInterval = 0;
            } else {
                // Danger: Red, Vibrate
                targetEl.style.background = "radial-gradient(circle, #ff4444 0%, #cc0000 100%)";
                targetEl.style.borderColor = "red";

                // Calculate Vibrate Speed
                // Closer to danger limit = Faster
                const clampedDist = Math.min(Math.max(dist, safeZone), dangerZone);
                const progress = (clampedDist - safeZone) / (dangerZone - safeZone); // 0.0 to 1.0
                
                // 0% progress (close) -> Slow Interval
                // 100% progress (far) -> Fast Interval
                currentHapticInterval = MAX_VIBRATION_INTERVAL - (progress * (MAX_VIBRATION_INTERVAL - MIN_VIBRATION_INTERVAL));
            }

            // D. TRIGGER HAPTIC
            if (currentHapticInterval > 0) {
                if (timestamp - lastHapticTime > currentHapticInterval) {
                    // Try Android
                    if (navigator.vibrate) navigator.vibrate(10);
                    // Try iOS Switch Hack
                    hapticSwitch.checked = !hapticSwitch.checked;
                    
                    lastHapticTime = timestamp;
                }
            }

            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>